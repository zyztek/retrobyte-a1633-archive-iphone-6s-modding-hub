import React, { useState, useEffect, useRef } from 'react';
import { RetroLayout } from '@/components/layout/RetroLayout';
import { RetroCard } from '@/components/ui/retro-card';
import { motion, AnimatePresence } from 'framer-motion';
import { Terminal, Zap, AlertTriangle, ShieldCheck, Activity } from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { ZERO_DAY_EXPLOITS } from '@shared/extended-data';
export function ExploitLabPage() {
  const [isPlaying, setIsPlaying] = useState(false);
  const [logs, setLogs] = useState<string[]>([]);
  const [cursorPos, setCursorPos] = useState(0);
  const [mode, setMode] = useState<'LEGACY' | 'ZERO_DAY'>('LEGACY');
  const [activeZeroDay, setActiveZeroDay] = useState(ZERO_DAY_EXPLOITS[0]);
  const [status, setStatus] = useState<'IDLE' | 'RACING' | 'PWNED' | 'FAILED'>('IDLE');
  const gameLoopRef = useRef<number>(0);

  // Keep settings in a ref to avoid recreating the loop function on every settings change
  const settingsRef = useRef(mode === 'LEGACY'
    ? { start: 75, end: 85, speed: 2 }
    : { start: 80, end: 80 + activeZeroDay.windowSize, speed: activeZeroDay.speed });

  useEffect(() => {
    settingsRef.current = mode === 'LEGACY'
      ? { start: 75, end: 85, speed: 2 }
      : { start: 80, end: 80 + activeZeroDay.windowSize, speed: activeZeroDay.speed };
  }, [mode, activeZeroDay]);

  const currentSettings = mode === 'LEGACY' 
    ? { start: 75, end: 85, speed: 2 } 
    : { start: 80, end: 80 + activeZeroDay.windowSize, speed: activeZeroDay.speed };

  const addLog = (msg: string) => {
    setLogs(prev => [...prev.slice(-10), `> [${new Date().toLocaleTimeString()}] ${msg}`]);
  };
  const startExploit = () => {
    setIsPlaying(true);
    setStatus('RACING');
    setCursorPos(0);
    addLog(`INITIATING ${mode === 'LEGACY' ? 'USB_STACK_OVERFLOW' : activeZeroDay.name}...`);
    addLog(`SENDING PAYLOAD AT ${currentSettings.speed}x CPU_TICKS...`);
  };
  const handleInject = () => {
    if (!isPlaying) return;
    setIsPlaying(false);
    if (cursorPos >= currentSettings.start && cursorPos <= currentSettings.end) {
      setStatus('PWNED');
      addLog(`${mode === 'LEGACY' ? 'BOOTROM' : 'KERNEL'}_CONTROL_ACQUIRED!`);
      addLog("INJECTING_PAYLOAD: SUCCESS");
      toast.success("SYSTEM_PWNED", { description: "checkm8 vulnerability successfully exploited." });
    } else {
      setStatus('FAILED');
      addLog("RACE_CONDITION_FAILED: MEM_CORRUPTION_DETECTED");
      addLog(`ERR_CODE: 0x${Math.floor(Math.random() * 0xFFFFFFFF).toString(16).toUpperCase()}`);
      toast.error("EXPLOIT_FAILED");
    }
  };
  useEffect(() => {
    if (isPlaying) {
      let direction = 1;
      const loop = () => {
        setCursorPos(prev => {
          const speed = settingsRef.current.speed;
          let next = prev + speed * direction;
          if (next >= 100) direction = -1;
          if (next <= 0) direction = 1;
          return next;
        });
        gameLoopRef.current = requestAnimationFrame(loop);
      };
    } else {
      cancelAnimationFrame(gameLoopRef.current);
    }
    return () => cancelAnimationFrame(gameLoopRef.current);
  }, [isPlaying]);
  return (
    <RetroLayout>
      <div className="max-w-4xl mx-auto space-y-8">
        <div className="flex items-center gap-4">
          <Activity className="size-10 text-neon-green animate-pulse" />
          <div>
            <h1 className="text-4xl font-bold retro-glow uppercase tracking-tighter">Exploit Lab</h1>
            <p className="text-xs text-neon-green/60 uppercase">Checkm8 Bootrom Race-Condition Simulator</p>
          </div>
        </div>

        <div className="flex gap-4 mb-6">
          <button 
            onClick={() => setMode('LEGACY')}
            className={cn(
              "px-4 py-2 border-2 uppercase text-xs font-bold transition-all",
              mode === 'LEGACY' ? "bg-neon-green text-black border-neon-green" : "border-neon-green/30 text-neon-green/50"
            )}
          >
            Legacy_checkm8
          </button>
          <button 
            onClick={() => setMode('ZERO_DAY')}
            className={cn(
              "px-4 py-2 border-2 uppercase text-xs font-bold transition-all",
              mode === 'ZERO_DAY' ? "bg-neon-pink text-white border-neon-pink" : "border-neon-pink/30 text-neon-pink/50"
            )}
          >
            Zero-Day_Sims
          </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div className="md:col-span-2 space-y-6">
            <RetroCard title="TIMING_MANIFOLD" status={status}>
              {mode === 'ZERO_DAY' && (
                <div className="flex gap-2 mb-4">
                  {ZERO_DAY_EXPLOITS.map(ex => (
                    <button
                      key={ex.id}
                      onClick={() => setActiveZeroDay(ex)}
                      className={cn(
                        "px-2 py-1 text-[9px] border font-bold uppercase",
                        activeZeroDay.id === ex.id ? "bg-neon-pink border-neon-pink text-white" : "border-white/20 text-white/40"
                      )}
                    >
                      {ex.name}
                    </button>
                  ))}
                </div>
              )}
              <div className="space-y-12 py-8">
                <div className={cn("relative h-12 bg-black/50 border-2", mode === 'LEGACY' ? "border-neon-green/30" : "border-neon-pink/30")}>
                  {/* Vulnerability Window */}
                  <div
                    className={cn("absolute h-full border-x animate-pulse", mode === 'LEGACY' ? "bg-neon-pink/20 border-neon-pink" : "bg-white/20 border-white")}
                    style={{ left: `${currentSettings.start}%`, width: `${currentSettings.end - currentSettings.start}%` }}
                  />
                  <motion.div
                    className={cn("absolute top-0 bottom-0 w-1 z-10", mode === 'LEGACY' ? "bg-neon-green shadow-[0_0_15px_rgba(0,255,65,1)]" : "bg-neon-pink shadow-[0_0_15px_rgba(210,9,250,1)]")}
                    style={{ left: `${cursorPos}%` }}
                  />
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-neon-pink uppercase">
                    VULNERABILITY_WINDOW_80ms
                  </div>
                </div>
                <div className="flex flex-col items-center gap-4">
                  <button
                    onMouseDown={isPlaying ? handleInject : startExploit}
                    className={cn(
                      "w-48 h-48 rounded-full border-4 flex flex-col items-center justify-center transition-all active:scale-95 group relative",
                      status === 'PWNED' ? "border-neon-green bg-neon-green/10" :
                      status === 'FAILED' ? "border-red-600 bg-red-600/10" :
                      isPlaying ? "border-neon-pink bg-neon-pink/10 animate-pulse" : "border-neon-green"
                    )}
                  >
                    <div className="absolute inset-0 bg-neon-green/5 rounded-full blur-xl group-hover:bg-neon-green/10 transition-all" />
                    <Zap className={cn("size-12 mb-2", isPlaying ? "text-neon-pink" : "text-neon-green")} />
                    <span className="text-xs font-bold uppercase tracking-widest">
                      {isPlaying ? "INJECT_NOW" : status === 'PWNED' ? "RETRY_SCAN" : "START_SEQUENCE"}
                    </span>
                  </button>
                  <p className="text-[10px] uppercase opacity-50 italic">Press trigger at precise alignment</p>
                </div>
              </div>
            </RetroCard>
            <RetroCard title="USB_LOG_STREAM" status="LIVE">
              <div className="h-40 bg-black/50 p-4 font-mono text-[10px] text-neon-green/70 space-y-1 overflow-hidden">
                {logs.map((log, i) => (
                  <div key={i}>{log}</div>
                ))}
                {isPlaying && <div className="animate-pulse">_</div>}
              </div>
            </RetroCard>
          </div>
          <div className="space-y-6">
            <RetroCard title="STATISTICS" variant={status === 'FAILED' ? 'danger' : 'default'}>
              <div className="space-y-4">
                <div className="flex justify-between text-xs border-b border-neon-green/20 pb-1">
                  <span className="opacity-60 uppercase">Timing_Offset:</span>
                  <span className="font-bold">{cursorPos.toFixed(2)}%</span>
                </div>
                <div className="flex justify-between text-xs border-b border-neon-green/20 pb-1">
                  <span className="opacity-60 uppercase">Race_Difficulty:</span>
                  <span className="text-neon-pink font-bold">LEGACY</span>
                </div>
                <div className="flex justify-between text-xs border-b border-neon-green/20 pb-1">
                  <span className="opacity-60 uppercase">Voltage_Glitch:</span>
                  <span className="text-neon-green font-bold">NOMINAL</span>
                </div>
              </div>
            </RetroCard>
            <RetroCard title="VULNERABILITY_INTEL" variant="warning">
              <div className="flex gap-3 items-start">
                <ShieldCheck className="size-5 text-yellow-400 shrink-0 mt-1" />
                <p className="text-[10px] leading-relaxed uppercase">
                  The A9 bootrom contains a hardware-level heap overflow. By timing a USB request during the state transition, we gain arbitrary code execution.
                </p>
              </div>
            </RetroCard>
            <div className="p-4 border-2 border-neon-pink bg-neon-pink/5 space-y-2">
              <div className="flex items-center gap-2 text-neon-pink font-bold text-xs uppercase">
                <AlertTriangle className="size-4" /> Thermal Warning
              </div>
              <p className="text-[9px] opacity-70 uppercase leading-tight">
                Repeated race condition simulations generate pseudo-entropy. Hardware strain simulated.
              </p>
            </div>
          </div>
        </div>
      </div>
    </RetroLayout>
  );
}